kd> dt win32k!tagWND
   +0x000 head             : _THRDESKHEAD
   +0x014 state            : Uint4B
   +0x014 bHasMeun         : Pos 0, 1 Bit
   +0x014 bHasVerticalScrollbar : Pos 1, 1 Bit
   +0x014 bHasHorizontalScrollbar : Pos 2, 1 Bit
   +0x014 bHasCaption      : Pos 3, 1 Bit
   +0x014 bSendSizeMoveMsgs : Pos 4, 1 Bit
   +0x014 bMsgBox          : Pos 5, 1 Bit
   +0x014 bActiveFrame     : Pos 6, 1 Bit
   +0x014 bHasSPB          : Pos 7, 1 Bit
   +0x014 bNoNCPaint       : Pos 8, 1 Bit
   +0x014 bSendEraseBackground : Pos 9, 1 Bit
   +0x014 bEraseBackground : Pos 10, 1 Bit
   +0x014 bSendNCPaint     : Pos 11, 1 Bit
   +0x014 bInternalPaint   : Pos 12, 1 Bit
   +0x014 bUpdateDirty     : Pos 13, 1 Bit
   +0x014 bHiddenPopup     : Pos 14, 1 Bit
   +0x014 bForceMenuDraw   : Pos 15, 1 Bit
   +0x014 bDialogWindow    : Pos 16, 1 Bit
   +0x014 bHasCreatestructName : Pos 17, 1 Bit
   +0x014 bServerSideWindowProc : Pos 18, 1 Bit
   +0x014 bAnsiWindowProc  : Pos 19, 1 Bit
   +0x014 bBeingActivated  : Pos 20, 1 Bit
   +0x014 bHasPalette      : Pos 21, 1 Bit
   +0x014 bPaintNotProcessed : Pos 22, 1 Bit
   +0x014 bSyncPaintPending : Pos 23, 1 Bit
   +0x014 bRecievedQuerySuspendMsg : Pos 24, 1 Bit
   +0x014 bRecievedSuspendMsg : Pos 25, 1 Bit
   +0x014 bToggleTopmost   : Pos 26, 1 Bit
   +0x014 bRedrawIfHung    : Pos 27, 1 Bit
   +0x014 bRedrawFrameIfHung : Pos 28, 1 Bit
   +0x014 bAnsiCreator     : Pos 29, 1 Bit
   +0x014 bMaximizesToMonitor : Pos 30, 1 Bit
   +0x014 bDestroyed       : Pos 31, 1 Bit
   +0x018 state2           : Uint4B
   +0x018 bWMPaintSent     : Pos 0, 1 Bit
   +0x018 bEndPaintInvalidate : Pos 1, 1 Bit
   +0x018 bStartPaint      : Pos 2, 1 Bit
   +0x018 bOldUI           : Pos 3, 1 Bit
   +0x018 bHasClientEdge   : Pos 4, 1 Bit
   +0x018 bBottomMost      : Pos 5, 1 Bit
   +0x018 bFullScreen      : Pos 6, 1 Bit
   +0x018 bInDestroy       : Pos 7, 1 Bit
   +0x018 bWin31Compat     : Pos 8, 1 Bit
   +0x018 bWin40Compat     : Pos 9, 1 Bit
   +0x018 bWin50Compat     : Pos 10, 1 Bit
   +0x018 bMaximizeMonitorRegion : Pos 11, 1 Bit
   +0x018 bCloseButtonDown : Pos 12, 1 Bit
   +0x018 bMaximizeButtonDown : Pos 13, 1 Bit
   +0x018 bMinimizeButtonDown : Pos 14, 1 Bit
   +0x018 bHelpButtonDown  : Pos 15, 1 Bit
   +0x018 bScrollBarLineUpBtnDown : Pos 16, 1 Bit
   +0x018 bScrollBarPageUpBtnDown : Pos 17, 1 Bit
   +0x018 bScrollBarPageDownBtnDown : Pos 18, 1 Bit
   +0x018 bScrollBarLineDownBtnDown : Pos 19, 1 Bit
   +0x018 bAnyScrollButtonDown : Pos 20, 1 Bit
   +0x018 bScrollBarVerticalTracking : Pos 21, 1 Bit
   +0x018 bForceNCPaint    : Pos 22, 1 Bit
   +0x018 bForceFullNCPaintClipRgn : Pos 23, 1 Bit
   +0x018 FullScreenMode   : Pos 24, 3 Bits
   +0x018 bCaptionTextTruncated : Pos 27, 1 Bit
   +0x018 bNoMinmaxAnimatedRects : Pos 28, 1 Bit
   +0x018 bSmallIconFromWMQueryDrag : Pos 29, 1 Bit
   +0x018 bShellHookRegistered : Pos 30, 1 Bit
   +0x018 bWMCreateMsgProcessed : Pos 31, 1 Bit
   +0x01c ExStyle          : Uint4B
   +0x01c bWS_EX_DLGMODALFRAME : Pos 0, 1 Bit
   +0x01c bUnused1         : Pos 1, 1 Bit
   +0x01c bWS_EX_NOPARENTNOTIFY : Pos 2, 1 Bit
   +0x01c bWS_EX_TOPMOST   : Pos 3, 1 Bit
   +0x01c bWS_EX_ACCEPTFILE : Pos 4, 1 Bit
   +0x01c bWS_EX_TRANSPARENT : Pos 5, 1 Bit
   +0x01c bWS_EX_MDICHILD  : Pos 6, 1 Bit
   +0x01c bWS_EX_TOOLWINDOW : Pos 7, 1 Bit
   +0x01c bWS_EX_WINDOWEDGE : Pos 8, 1 Bit
   +0x01c bWS_EX_CLIENTEDGE : Pos 9, 1 Bit
   +0x01c bWS_EX_CONTEXTHELP : Pos 10, 1 Bit
   +0x01c bMakeVisibleWhenUnghosted : Pos 11, 1 Bit
   +0x01c bWS_EX_RIGHT     : Pos 12, 1 Bit
   +0x01c bWS_EX_RTLREADING : Pos 13, 1 Bit
   +0x01c bWS_EX_LEFTSCROLLBAR : Pos 14, 1 Bit
   +0x01c bUnused2         : Pos 15, 1 Bit
   +0x01c bWS_EX_CONTROLPARENT : Pos 16, 1 Bit
   +0x01c bWS_EX_STATICEDGE : Pos 17, 1 Bit
   +0x01c bWS_EX_APPWINDOW : Pos 18, 1 Bit
   +0x01c bWS_EX_LAYERED   : Pos 19, 1 Bit
   +0x01c bWS_EX_NOINHERITLAYOUT : Pos 20, 1 Bit
   +0x01c bUnused3         : Pos 21, 1 Bit
   +0x01c bWS_EX_LAYOUTRTL : Pos 22, 1 Bit
   +0x01c bWS_EX_NOPADDEDBORDER : Pos 23, 1 Bit
   +0x01c bUnused4         : Pos 24, 1 Bit
   +0x01c bWS_EX_COMPOSITED : Pos 25, 1 Bit
   +0x01c bUIStateActive   : Pos 26, 1 Bit
   +0x01c bWS_EX_NOACTIVATE : Pos 27, 1 Bit
   +0x01c bWS_EX_COMPOSITEDCompositing : Pos 28, 1 Bit
   +0x01c bRedirected      : Pos 29, 1 Bit
   +0x01c bUIStateKbdAccelHidden : Pos 30, 1 Bit
   +0x01c bUIStateFocusRectHidden : Pos 31, 1 Bit
   +0x020 style            : Uint4B
   +0x020 bReserved1       : Pos 0, 16 Bits
   +0x020 bWS_MAXIMIZEBOX  : Pos 16, 1 Bit
   +0x020 bReserved2       : Pos 0, 16 Bits
   +0x020 bWS_TABSTOP      : Pos 16, 1 Bit
   +0x020 bReserved3       : Pos 0, 16 Bits
   +0x020 bUnused5         : Pos 16, 1 Bit
   +0x020 bWS_MINIMIZEBOX  : Pos 17, 1 Bit
   +0x020 bReserved4       : Pos 0, 16 Bits
   +0x020 bUnused6         : Pos 16, 1 Bit
   +0x020 bWS_GROUP        : Pos 17, 1 Bit
   +0x020 bReserved5       : Pos 0, 16 Bits
   +0x020 bUnused7         : Pos 16, 2 Bits
   +0x020 bWS_THICKFRAME   : Pos 18, 1 Bit
   +0x020 bReserved6       : Pos 0, 16 Bits
   +0x020 bUnused8         : Pos 16, 2 Bits
   +0x020 bWS_SIZEBOX      : Pos 18, 1 Bit
   +0x020 bReserved7       : Pos 0, 16 Bits
   +0x020 bUnused9         : Pos 16, 3 Bits
   +0x020 bWS_SYSMENU      : Pos 19, 1 Bit
   +0x020 bWS_HSCROLL      : Pos 20, 1 Bit
   +0x020 bWS_VSCROLL      : Pos 21, 1 Bit
   +0x020 bWS_DLGFRAME     : Pos 22, 1 Bit
   +0x020 bWS_BORDER       : Pos 23, 1 Bit
   +0x020 bMaximized       : Pos 24, 1 Bit
   +0x020 bWS_CLIPCHILDREN : Pos 25, 1 Bit
   +0x020 bWS_CLIPSIBLINGS : Pos 26, 1 Bit
   +0x020 bDisabled        : Pos 27, 1 Bit
   +0x020 bVisible         : Pos 28, 1 Bit
   +0x020 bMinimized       : Pos 29, 1 Bit
   +0x020 bWS_CHILD        : Pos 30, 1 Bit
   +0x020 bWS_POPUP        : Pos 31, 1 Bit
   +0x024 hModule          : Ptr32 Void
   +0x028 hMod16           : Uint2B
   +0x02a fnid             : Uint2B
   +0x02c spwndNext        : Ptr32 tagWND
   +0x030 spwndPrev        : Ptr32 tagWND
   +0x034 spwndParent      : Ptr32 tagWND
   +0x038 spwndChild       : Ptr32 tagWND
   +0x03c spwndOwner       : Ptr32 tagWND
   +0x040 rcWindow         : tagRECT
   +0x050 rcClient         : tagRECT
   +0x060 lpfnWndProc      : Ptr32     long 
   +0x064 pcls             : Ptr32 tagCLS
   +0x068 hrgnUpdate       : Ptr32 HRGN__
   +0x06c ppropList        : Ptr32 tagPROPLIST
   +0x070 pSBInfo          : Ptr32 tagSBINFO
   +0x074 spmenuSys        : Ptr32 tagMENU
   +0x078 spmenu           : Ptr32 tagMENU
   +0x07c hrgnClip         : Ptr32 HRGN__
   +0x080 hrgnNewFrame     : Ptr32 HRGN__
   +0x084 strName          : _LARGE_UNICODE_STRING
   +0x090 cbwndExtra       : Int4B
   +0x094 spwndLastActive  : Ptr32 tagWND
   +0x098 hImc             : Ptr32 HIMC__
   +0x09c dwUserData       : Uint4B
   +0x0a0 pActCtx          : Ptr32 _ACTIVATION_CONTEXT
   +0x0a4 pTransform       : Ptr32 _D3DMATRIX
   +0x0a8 spwndClipboardListenerNext : Ptr32 tagWND
   +0x0ac ExStyle2         : Uint4B
   +0x0ac bClipboardListener : Pos 0, 1 Bit
   +0x0ac bLayeredInvalidate : Pos 1, 1 Bit
   +0x0ac bRedirectedForPrint : Pos 2, 1 Bit
   +0x0ac bLinked          : Pos 3, 1 Bit
   +0x0ac bLayeredForDWM   : Pos 4, 1 Bit
   +0x0ac bLayeredLimbo    : Pos 5, 1 Bit
   +0x0ac bHIGHDPI_UNAWARE_Unused : Pos 6, 1 Bit
   +0x0ac bVerticallyMaximizedLeft : Pos 7, 1 Bit
   +0x0ac bVerticallyMaximizedRight : Pos 8, 1 Bit
   +0x0ac bHasOverlay      : Pos 9, 1 Bit
   +0x0ac bConsoleWindow   : Pos 10, 1 Bit
   +0x0ac bChildNoActivate : Pos 11, 1 Bit

kd> r
eax=fffffe0d ebx=000001ed ecx=902920e4 edx=951f4c78 esi=fffffffb edi=fe5d9dd8
eip=901393fa esp=951f4b3c ebp=951f4b64 iopl=0         nv up ei ng nz na pe nc
cs=0008  ss=0010  ds=0023  es=0023  fs=0030  gs=0000             efl=00010286
win32k!xxxSendMessageTimeout+0xb3:
901393fa 3b7e08          cmp     edi,dword ptr [esi+8] ds:0023:00000003=????????

kd> u
win32k!xxxSendMessageTimeout+0xb3:
901393fa 3b7e08          cmp     edi,dword ptr [esi+8]
901393fd 0f8484000000    je      win32k!xxxSendMessageTimeout+0x140 (90139487)
90139403 8b0e            mov     ecx,dword ptr [esi]
90139405 8b15e4d12990    mov     edx,dword ptr [win32k!gSharedInfo+0x4 (9029d1e4)]
9013940b 81e1ffff0000    and     ecx,0FFFFh
90139411 0faf0de8d12990  imul    ecx,dword ptr [win32k!gSharedInfo+0x8 (9029d1e8)]
90139418 33c0            xor     eax,eax
9013941a f644110901      test    byte ptr [ecx+edx+9],1
kd> kb
ChildEBP RetAddr  Args to Child              
951f4b64 901395c5 fffffffb 000001ed 0071fc6c win32k!xxxSendMessageTimeout+0xb3
951f4b8c 901b92fb fffffffb 000001ed 0071fc6c win32k!xxxSendMessage+0x28
951f4bec 901b8c1f 951f4c0c 00000000 0071fc6c win32k!xxxHandleMenuMessages+0x582
951f4c38 901bf8f1 ffb0d320 9029f580 00000000 win32k!xxxMNLoop+0x2c6
951f4ca0 901bf9dc 0000001c 00000000 ffffd8f0 win32k!xxxTrackPopupMenuEx+0x5cd
951f4d14 8284587a 00280203 00000000 ffffd8f0 win32k!NtUserTrackPopupMenuEx+0xc3
951f4d14 775e70b4 00280203 00000000 ffffd8f0 nt!KiFastCallEntry+0x12a
0071fc80 75a2483e 75a12243 00280203 00000000 ntdll!KiFastSystemCallRet
0071fc84 75a12243 00280203 00000000 ffffd8f0 USER32!NtUserTrackPopupMenuEx+0xc
0071fca4 011014b6 00280203 00000000 ffffd8f0 USER32!TrackPopupMenu+0x1b
0071fd04 75c23c45 00000000 0071fd50 776037f5 CVE_2014_4113!ExploitThread+0x156 [c:\documents and settings\administrator\my documents\visual studio 2010\projects\cve-2014-4113\cve-2014-4113\cve-2014-4113.c @ 233]
0071fd10 776037f5 00000000 7708ca21 00000000 kernel32!BaseThreadInitThunk+0xe
0071fd50 776037c8 01101360 00000000 00000000 ntdll!__RtlUserThreadStart+0x70
0071fd68 00000000 01101360 00000000 00000000 ntdll!_RtlUserThreadStart+0x1b
