kd> uf win32k!xxxSendMessageTimeout
win32k!xxxSendMessageTimeout:
90599347 8bff            mov     edi,edi
90599349 55              push    ebp
9059934a 8bec            mov     ebp,esp
9059934c 83ec1c          sub     esp,1Ch
9059934f 56              push    esi
90599350 57              push    edi
90599351 8b7d20          mov     edi,dword ptr [ebp+20h]
90599354 85ff            test    edi,edi
90599356 7403            je      win32k!xxxSendMessageTimeout+0x14 (9059935b)

win32k!xxxSendMessageTimeout+0x11:
90599358 832700          and     dword ptr [edi],0

win32k!xxxSendMessageTimeout+0x14:
9059935b 8b7508          mov     esi,dword ptr [ebp+8]
9059935e 83feff          cmp     esi,0FFFFFFFFh
90599361 7537            jne     win32k!xxxSendMessageTimeout+0x53 (9059939a)

win32k!xxxSendMessageTimeout+0x1c:
90599363 33c0            xor     eax,eax
90599365 33c9            xor     ecx,ecx
90599367 85ff            test    edi,edi
90599369 7415            je      win32k!xxxSendMessageTimeout+0x39 (90599380)

win32k!xxxSendMessageTimeout+0x24:
9059936b 8b4518          mov     eax,dword ptr [ebp+18h]
9059936e 8945f4          mov     dword ptr [ebp-0Ch],eax
90599371 8b451c          mov     eax,dword ptr [ebp+1Ch]
90599374 6a04            push    4
90599376 8945f8          mov     dword ptr [ebp-8],eax
90599379 59              pop     ecx
9059937a 897dfc          mov     dword ptr [ebp-4],edi
9059937d 8d45f4          lea     eax,[ebp-0Ch]

win32k!xxxSendMessageTimeout+0x39:
90599380 ff7524          push    dword ptr [ebp+24h]
90599383 50              push    eax
90599384 51              push    ecx
90599385 ff7514          push    dword ptr [ebp+14h]
90599388 ff7510          push    dword ptr [ebp+10h]
9059938b ff750c          push    dword ptr [ebp+0Ch]
9059938e 6a00            push    0
90599390 e86bc5f7ff      call    win32k!xxxBroadcastMessage (90515900)
90599395 e9f8010000      jmp     win32k!xxxSendMessageTimeout+0x24b (90599592)

win32k!xxxSendMessageTimeout+0x53:
9059939a 53              push    ebx
9059939b 8b5d0c          mov     ebx,dword ptr [ebp+0Ch]
9059939e 8d8320fcffff    lea     eax,[ebx-3E0h]
905993a4 83f808          cmp     eax,8
905993a7 774b            ja      win32k!xxxSendMessageTimeout+0xad (905993f4)

win32k!xxxSendMessageTimeout+0x62:
905993a9 ff7514          push    dword ptr [ebp+14h]
905993ac ff7510          push    dword ptr [ebp+10h]
905993af 53              push    ebx
905993b0 56              push    esi
905993b1 e8b5750400      call    win32k!xxxDDETrackSendHook (905e096b)
905993b6 85c0            test    eax,eax
905993b8 0f8423010000    je      win32k!xxxSendMessageTimeout+0x19a (905994e1)

win32k!xxxSendMessageTimeout+0x77:
905993be 81fbe0030000    cmp     ebx,3E0h
905993c4 751a            jne     win32k!xxxSendMessageTimeout+0x99 (905993e0)

win32k!xxxSendMessageTimeout+0x7f:
905993c6 a1d8f66f90      mov     eax,dword ptr [win32k!guDdeSendTimeout (906ff6d8)]
905993cb 85c0            test    eax,eax
905993cd 7411            je      win32k!xxxSendMessageTimeout+0x99 (905993e0)

win32k!xxxSendMessageTimeout+0x88:
905993cf 85ff            test    edi,edi
905993d1 7506            jne     win32k!xxxSendMessageTimeout+0x92 (905993d9)

win32k!xxxSendMessageTimeout+0x8c:
905993d3 8d4d0c          lea     ecx,[ebp+0Ch]
905993d6 894d20          mov     dword ptr [ebp+20h],ecx

win32k!xxxSendMessageTimeout+0x92:
905993d9 834d1802        or      dword ptr [ebp+18h],2
905993dd 89451c          mov     dword ptr [ebp+1Ch],eax

win32k!xxxSendMessageTimeout+0x99:
905993e0 56              push    esi
905993e1 ff7510          push    dword ptr [ebp+10h]
905993e4 e854750400      call    win32k!ValidateDDEConvPair (905e093d)
905993e9 85c0            test    eax,eax
905993eb 7407            je      win32k!xxxSendMessageTimeout+0xad (905993f4)

win32k!xxxSendMessageTimeout+0xa6:
905993ed c7452401000000  mov     dword ptr [ebp+24h],1

win32k!xxxSendMessageTimeout+0xad:
905993f4 8b3d58eb6f90    mov     edi,dword ptr [win32k!gptiCurrent (906feb58)]
905993fa 3b7e08          cmp     edi,dword ptr [esi+8] -> crash
905993fd 0f8484000000    je      win32k!xxxSendMessageTimeout+0x140 (90599487)

win32k!xxxSendMessageTimeout+0xbc:
90599403 8b0e            mov     ecx,dword ptr [esi]
90599405 8b15e4d16f90    mov     edx,dword ptr [win32k!gSharedInfo+0x4 (906fd1e4)]
9059940b 81e1ffff0000    and     ecx,0FFFFh
90599411 0faf0de8d16f90  imul    ecx,dword ptr [win32k!gSharedInfo+0x8 (906fd1e8)]
90599418 33c0            xor     eax,eax
9059941a f644110901      test    byte ptr [ecx+edx+9],1
9059941f 7412            je      win32k!xxxSendMessageTimeout+0xec (90599433)

win32k!xxxSendMessageTimeout+0xda:
90599421 ff7514          push    dword ptr [ebp+14h]
90599424 ff7510          push    dword ptr [ebp+10h]
90599427 53              push    ebx
90599428 56              push    esi
90599429 e823e1fcff      call    win32k!xxxDefWindowProc (90567551)
9059942e e95e010000      jmp     win32k!xxxSendMessageTimeout+0x24a (90599591)

win32k!xxxSendMessageTimeout+0xec:
90599433 837d2000        cmp     dword ptr [ebp+20h],0
90599437 7434            je      win32k!xxxSendMessageTimeout+0x126 (9059946d)

win32k!xxxSendMessageTimeout+0xf2:
90599439 f6451802        test    byte ptr [ebp+18h],2
9059943d 7412            je      win32k!xxxSendMessageTimeout+0x10a (90599451)

win32k!xxxSendMessageTimeout+0xf8:
9059943f 6a00            push    0
90599441 ff7608          push    dword ptr [esi+8]
90599444 e8ab100100      call    win32k!IsThreadHung (905aa4f4)
90599449 85c0            test    eax,eax
9059944b 0f8590000000    jne     win32k!xxxSendMessageTimeout+0x19a (905994e1)

win32k!xxxSendMessageTimeout+0x10a:
90599451 8b4518          mov     eax,dword ptr [ebp+18h]
90599454 8945f4          mov     dword ptr [ebp-0Ch],eax
90599457 8b451c          mov     eax,dword ptr [ebp+1Ch]
9059945a 8945f8          mov     dword ptr [ebp-8],eax
9059945d 8b4520          mov     eax,dword ptr [ebp+20h]
90599460 8945fc          mov     dword ptr [ebp-4],eax
90599463 c745e402000000  mov     dword ptr [ebp-1Ch],2
9059946a 8d45e4          lea     eax,[ebp-1Ch]

win32k!xxxSendMessageTimeout+0x126:
9059946d ff7524          push    dword ptr [ebp+24h]
90599470 50              push    eax
90599471 ff7608          push    dword ptr [esi+8]
90599474 57              push    edi
90599475 ff7514          push    dword ptr [ebp+14h]
90599478 ff7510          push    dword ptr [ebp+10h]
9059947b 53              push    ebx
9059947c 56              push    esi
9059947d e82e07fcff      call    win32k!xxxInterSendMsgEx (90559bb0)
90599482 e90a010000      jmp     win32k!xxxSendMessageTimeout+0x24a (90599591)

win32k!xxxSendMessageTimeout+0x140:
90599487 8b87cc000000    mov     eax,dword ptr [edi+0CCh]
9059948d 8b400c          mov     eax,dword ptr [eax+0Ch]
90599490 0b872c010000    or      eax,dword ptr [edi+12Ch]
90599496 a820            test    al,20h
90599498 7426            je      win32k!xxxSendMessageTimeout+0x179 (905994c0)

win32k!xxxSendMessageTimeout+0x153:
9059949a 8b06            mov     eax,dword ptr [esi]
9059949c 8945f8          mov     dword ptr [ebp-8],eax
9059949f 8b4510          mov     eax,dword ptr [ebp+10h]
905994a2 8945f0          mov     dword ptr [ebp-10h],eax
905994a5 8b4514          mov     eax,dword ptr [ebp+14h]
905994a8 6a04            push    4
905994aa 8d4dec          lea     ecx,[ebp-14h]
905994ad 8945ec          mov     dword ptr [ebp-14h],eax
905994b0 33c0            xor     eax,eax
905994b2 51              push    ecx
905994b3 50              push    eax
905994b4 50              push    eax
905994b5 895df4          mov     dword ptr [ebp-0Ch],ebx
905994b8 8945fc          mov     dword ptr [ebp-4],eax
905994bb e85deefcff      call    win32k!xxxCallHook (9056831d)

win32k!xxxSendMessageTimeout+0x179:
905994c0 f6461604        test    byte ptr [esi+16h],4 -> this is WS_EXECUTE_IN_KERNEL thing
905994c4 8d4518          lea     eax,[ebp+18h]
905994c7 50              push    eax
905994c8 743b            je      win32k!xxxSendMessageTimeout+0x1be (90599505)

win32k!xxxSendMessageTimeout+0x183:
905994ca 8d451c          lea     eax,[ebp+1Ch]
905994cd 50              push    eax
905994ce ff15bc046d90    call    dword ptr [win32k!_imp__IoGetStackLimits (906d04bc)]
905994d4 8d4518          lea     eax,[ebp+18h]
905994d7 2b451c          sub     eax,dword ptr [ebp+1Ch]
905994da 3d00100000      cmp     eax,1000h
905994df 7307            jae     win32k!xxxSendMessageTimeout+0x1a1 (905994e8)

win32k!xxxSendMessageTimeout+0x19a:
905994e1 33c0            xor     eax,eax
905994e3 e9a9000000      jmp     win32k!xxxSendMessageTimeout+0x24a (90599591)

win32k!xxxSendMessageTimeout+0x1a1:
905994e8 ff7514          push    dword ptr [ebp+14h]
905994eb ff7510          push    dword ptr [ebp+10h]
905994ee 53              push    ebx
905994ef 56              push    esi
905994f0 ff5660          call    dword ptr [esi+60h] ->> Success this calls the shellcode
905994f3 8b4d20          mov     ecx,dword ptr [ebp+20h]
905994f6 85c9            test    ecx,ecx
905994f8 0f8493000000    je      win32k!xxxSendMessageTimeout+0x24a (90599591)

win32k!xxxSendMessageTimeout+0x1b7:
905994fe 8901            mov     dword ptr [ecx],eax
90599500 e985000000      jmp     win32k!xxxSendMessageTimeout+0x243 (9059958a)

win32k!xxxSendMessageTimeout+0x1be:
90599505 6a00            push    0
90599507 6a00            push    0
90599509 ff7514          push    dword ptr [ebp+14h]
9059950c ff7510          push    dword ptr [ebp+10h]
9059950f 53              push    ebx
90599510 56              push    esi
90599511 e81aaaffff      call    win32k!xxxSendMessageToClient (90593f30)
90599516 8b87cc000000    mov     eax,dword ptr [edi+0CCh]
9059951c 8b400c          mov     eax,dword ptr [eax+0Ch]
9059951f 0b872c010000    or      eax,dword ptr [edi+12Ch]
90599525 8b7d18          mov     edi,dword ptr [ebp+18h]
90599528 a900200000      test    eax,2000h
9059952d 7429            je      win32k!xxxSendMessageTimeout+0x211 (90599558)

win32k!xxxSendMessageTimeout+0x1e8:
9059952f 8b06            mov     eax,dword ptr [esi]
90599531 8945f8          mov     dword ptr [ebp-8],eax
90599534 8b4510          mov     eax,dword ptr [ebp+10h]
90599537 8945f0          mov     dword ptr [ebp-10h],eax
9059953a 8b4514          mov     eax,dword ptr [ebp+14h]
9059953d 6a0c            push    0Ch
9059953f 8d4de8          lea     ecx,[ebp-18h]
90599542 8945ec          mov     dword ptr [ebp-14h],eax
90599545 33c0            xor     eax,eax
90599547 51              push    ecx
90599548 50              push    eax
90599549 50              push    eax
9059954a 895df4          mov     dword ptr [ebp-0Ch],ebx
9059954d 897de8          mov     dword ptr [ebp-18h],edi
90599550 8945fc          mov     dword ptr [ebp-4],eax
90599553 e8c5edfcff      call    win32k!xxxCallHook (9056831d)

win32k!xxxSendMessageTimeout+0x211:
90599558 8d83c0fdffff    lea     eax,[ebx-240h]
9059955e 83f80f          cmp     eax,0Fh
90599561 770c            ja      win32k!xxxSendMessageTimeout+0x228 (9059956f)

win32k!xxxSendMessageTimeout+0x21c:
90599563 6a01            push    1
90599565 ff7514          push    dword ptr [ebp+14h]
90599568 e88c5d0b00      call    win32k!_FreeTouchInputInfo (9064f2f9)
9059956d eb12            jmp     win32k!xxxSendMessageTimeout+0x23a (90599581)

win32k!xxxSendMessageTimeout+0x228:
9059956f 81fb19010000    cmp     ebx,119h
90599575 750a            jne     win32k!xxxSendMessageTimeout+0x23a (90599581)

win32k!xxxSendMessageTimeout+0x230:
90599577 6a01            push    1
90599579 ff7514          push    dword ptr [ebp+14h]
9059957c e8b2060c00      call    win32k!_FreeGestureInfo (90659c33)

win32k!xxxSendMessageTimeout+0x23a:
90599581 8b4520          mov     eax,dword ptr [ebp+20h]
90599584 85c0            test    eax,eax
90599586 7407            je      win32k!xxxSendMessageTimeout+0x248 (9059958f)

win32k!xxxSendMessageTimeout+0x241:
90599588 8938            mov     dword ptr [eax],edi

win32k!xxxSendMessageTimeout+0x243:
9059958a 33c0            xor     eax,eax
9059958c 40              inc     eax
9059958d eb02            jmp     win32k!xxxSendMessageTimeout+0x24a (90599591)

win32k!xxxSendMessageTimeout+0x248:
9059958f 8bc7            mov     eax,edi

win32k!xxxSendMessageTimeout+0x24a:
90599591 5b              pop     ebx

win32k!xxxSendMessageTimeout+0x24b:
90599592 5f              pop     edi
90599593 5e              pop     esi
90599594 c9              leave
90599595 c22000          ret     20h
